#!/usr/bin/env php
<?php

declare(strict_types=1);

// Load autoloader and environment
require_once __DIR__.'/vendor/autoload.php';
$guacamolePath = __DIR__.'/src/Guacamole/Guacamole.php';
if (!file_exists($guacamolePath)) {
    $guacamolePath = str_replace('/src/', '/dist/', $guacamolePath);
}
require_once $guacamolePath;

use Console\Commands\MigrationsCommand;
use Console\Tools\Output;

// Parse command line arguments
$args = array_slice($argv, 1);

if (empty($args)) {
    showHelp();
    exit(1);
}

$verb = $args[0];
$options = array_slice($args, 1);

// Route commands
try {
    match ($verb) {
        'migrations' => (new MigrationsCommand())->handle($options),
        default => showUnknownCommand($verb),
    };
} catch (\Exception $e) {
    Output::error("Command execution failed: ".$e->getMessage());
    exit(1);
}

/**
 * Show general help
 */
function showHelp(): void {
    Output::line("Guacamole CLI Tool");
    Output::line("");
    Output::line("Usage:");
    Output::line("  php guacamole <verb> [options]");
    Output::line("");
    Output::line("Available verbs:");
    Output::line("  migrations  - Database migration operations");
    Output::line("");
    Output::line("Examples:");
    Output::line("  php guacamole migrations check");
    Output::line("  php guacamole migrations roll");
    Output::line("");
    Output::line("For verb-specific help, use:");
    Output::line("  php guacamole <verb>");
}

/**
 * Show unknown command error
 */
function showUnknownCommand(string $verb): void {
    Output::error("Unknown command: {$verb}");
    Output::line("");
    showHelp();
    exit(1);
}